Platform : Connection Security
==============================

This page last changed on Feb 12, 2013 by cbugot.

Key storage on the embedded device
==================================

Key are stored on embedded devices in a file crypto/crypto.keys. They
are obfuscated with an AES key, but this doesn't constitute proper
encryption, as the key is in the code and can be retrieved by a
motivated attacker with access to the hardware. The possibility is
contemplated, for future versions of the agent, to let users plug
alternative obfuscation methods in the system.

Another risk mitigation measure is that keys retrieved from the key
store are never passed directly to Lua. Instead, all Lua cryptographic
primitives can access keys through their index in the key store. This
means that every key used to encrypt or sign data must be put in the
store, even if it is derived from a key already present in the store.

The keys are, in order:

-   PROVIS\_KS = MD5(server\_id .. MD5(preshared))
-   PROVIS\_KD = MD5(device\_id .. MD5(preshared))
-   CRYPTO\_K = MD5(password)
-   AUTH\_KS = MD5(server\_id .. MD5(password))
-   AUTH\_KD = MD5(device\_id .. MD5(password))

Where `preshared` is the provisioning secret, generally common to a
series of devices, and used to download the actual signing and
encryption key CRYPTO\_K. `password` is the final, device-specific
secret used to generate the actual security keys.

The keys have indexes 1...5 in Lua. Beware that in the keystore and the
C code, they have indexes 0...4.

Preshared and final keys can be provisionned in a device through telnet.

-   after building the agent, run "make agent\_provisioning" in the
    build directory (the manual key provisioning system isn't currently
    included by default).
-   launch the agetn and connect through telnet on port 2000; then you
    can:
-   set the preshared
    secret:` require 'agent.provisioning' .registration_password "foobar"`
-   set the preshared secret's MD5
    directly:` require 'agent.provisioning' .registration_password_md5_hex "12c3bdd984321313..."`
-   directly set the cipher+authentication password:
    `require 'agent.provisioning' .password "foobar"`
-   set the cipher+authentication password's MD5:
    `require 'agent.provisioning' .password_md5_hex "12c3bdd984321313..."`

There's also a C API, but at a lower level; you have to compute the keys
yourself before writing them down in the store. The writing is preformed
by `set_plain_bin_keys( first_key, n_keys, keys)`, in
`libs/keystore/keystore.[ch]`.

In the keystore, keys are ciphered with an AES-128 key embedded in the
code. Moreover, this key is rotated n bytes to the left to encrypt the
key at index n (this prevents identical keys from having the same
encrypted forms).

Document generated by Confluence on Mar 11, 2013 16:16
